
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Dutch Auction v2.1</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="/socket.io/socket.io.js"></script>
  <style>
    body { font-family: sans-serif; padding: 1rem; text-align: center; }
    .hidden { display: none; }
    #price { font-size: 3rem; color: red; margin: 1rem 0; }
    input, button { padding: 0.6rem; font-size: 1rem; margin: 0.3rem; }
    table { margin-top: 1rem; width: 100%; font-size: 0.9rem; }
    td, th { padding: 0.2rem 0.4rem; }
  </style>
</head>
<body>
  <div id="role-select">
    <h2>è«‹é¸æ“‡æ‚¨çš„èº«åˆ†</h2>
    <button onclick="setRole('host')">æˆ‘æ˜¯ä¸»æŒäºº</button>
    <button onclick="setRole('user')">æˆ‘æ˜¯åƒèˆ‡è€…</button>
  </div>

  <div id="host-login" class="hidden">
    <h3>è¼¸å…¥ä¸»æŒäººå¯†ç¢¼</h3>
    <input type="password" id="host-pw">
    <button onclick="verifyHost()">ç™»å…¥</button>
    <p id="host-status"></p>
  </div>

  <div id="nickname-area" class="hidden">
    <h3>è«‹è¼¸å…¥æ‚¨çš„æš±ç¨±</h3>
    <input id="nickname">
    <button onclick="submitNickname()">é€å‡º</button>
  </div>

  <div id="host-panel" class="hidden">
    <h3>è¼¸å…¥æ‹è³£è³‡è¨Š</h3>
    <input id="item" placeholder="æ‹è³£å“åç¨±">
    <input id="startPrice" type="number" placeholder="èµ·å§‹åƒ¹æ ¼">
    <input id="minPrice" type="number" placeholder="æœ€ä½åƒ¹æ ¼">
    <input id="decrement" type="number" placeholder="æ¯æ¬¡éæ¸›">
    <input id="interval" type="number" placeholder="éæ¸›é–“éš”æ¯«ç§’">
    <br>
    <button onclick="startAuction()">â–¶ï¸ é–‹å§‹æ‹è³£</button>
    <button onclick="endAuction()">â¹ï¸ çµæŸæ‹è³£</button>
  </div>

  <div id="auction" class="hidden">
    <h2 id="item-name">æ‹è³£å“ï¼š-</h2>
    <div id="price">-</div>
    <button id="bidBtn" onclick="bid()">æ¶æ¨™</button>
    <p id="result"></p>
  </div>

  <div id="history">
    <h3>å¾—æ¨™ç´€éŒ„</h3>
    <table border="1" style="margin:auto;">
      <thead><tr><th>æ™‚é–“</th><th>å¾—æ¨™è€…</th><th>èŠ±å‰</th><th>åƒ¹æ ¼</th></tr></thead>
      <tbody id="history-body"></tbody>
    </table>
  </div>

  <script>
    const socket = io();
    let role = "", nickname = "";

    function setRole(r) {
      role = r;
      document.getElementById("role-select").classList.add("hidden");
      if (r === 'host') document.getElementById("host-login").classList.remove("hidden");
      else document.getElementById("nickname-area").classList.remove("hidden");
      socket.emit('get-history');
    }

    function verifyHost() {
      const pw = document.getElementById("host-pw").value;
      socket.emit('verify-host', pw);
    }

    socket.on('host-verified', ok => {
      if (ok) {
        document.getElementById("host-status").innerText = "âœ… é©—è­‰æˆåŠŸ";
        document.getElementById("host-login").classList.add("hidden");
        document.getElementById("host-panel").classList.remove("hidden");
        document.getElementById("auction").classList.remove("hidden");
      } else {
        document.getElementById("host-status").innerText = "âŒ å¯†ç¢¼éŒ¯èª¤";
      }
    });

    function submitNickname() {
      nickname = document.getElementById("nickname").value.trim();
      if (!nickname) return alert("è«‹è¼¸å…¥æš±ç¨±ï¼");
      socket.emit('set-nickname', nickname);
      document.getElementById("nickname-area").classList.add("hidden");
      document.getElementById("auction").classList.remove("hidden");
    }

    function startAuction() {
      const data = {
        item: document.getElementById("item").value,
        price: Number(document.getElementById("startPrice").value),
        minPrice: Number(document.getElementById("minPrice").value),
        decrement: Number(document.getElementById("decrement").value),
        interval: Number(document.getElementById("interval").value)
      };
      if (!data.item || !data.price || !data.minPrice || !data.decrement || !data.interval) {
        alert("è«‹å®Œæ•´å¡«å¯«æ‹è³£è³‡æ–™");
        return;
      }
      socket.emit('start-auction', data);
    }

    function endAuction() {
      socket.emit('end-auction');
    }

    function bid() {
      socket.emit('bid');
    }

    socket.on('auction-started', data => {
      document.getElementById("item-name").innerText = "æ‹è³£å“ï¼š" + data.item;
      document.getElementById("price").innerText = "$" + data.price;
      document.getElementById("result").innerText = "";
      document.getElementById("bidBtn").disabled = false;
    });

    socket.on('price-updated', data => {
      document.getElementById("price").innerText = "$" + data.price;
    });

    socket.on('auction-won', data => {
      document.getElementById("result").innerText = `ğŸ‰ ${data.winner} ä»¥ $${data.price} å¾—æ¨™ ${data.item}`;
      document.getElementById("bidBtn").disabled = true;
    });

    socket.on('auction-ended', data => {
      document.getElementById("result").innerText = 'âš ï¸ æ‹è³£çµæŸï¼Œ' + (data.reason === 'no-bid' ? 'ç„¡äººå‡ºåƒ¹' : 'æ‰‹å‹•åœæ­¢');
      document.getElementById("bidBtn").disabled = true;
    });

    socket.on('history-updated', list => {
      const body = document.getElementById("history-body");
      body.innerHTML = "";
      list.forEach(r => {
        const row = `<tr><td>${r.time}</td><td>${r.winner}</td><td>${r.item}</td><td>$${r.price}</td></tr>`;
        body.innerHTML += row;
      });
    });
  </script>
</body>
</html>
